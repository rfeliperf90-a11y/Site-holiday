<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Debug Profile</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a2e; color: white; }
        .debug { background: #0f3460; padding: 20px; border-radius: 5px; height: 600px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-bottom: 1px solid #333; }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .info { color: #0099ff; }
        button { padding: 10px; margin: 5px; background: #e94560; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Profile Load Debug</h1>
    <button onclick="locations = 'profile.html'">Go to Profile</button>
    <button onclick="testLoadProfile()">Test Load (Simulated)</button>
    <div class="debug" id="debug"></div>

    <script>
        window.DEBUG_LOGS = [];
        
        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const fullMsg = `[${time}] ${msg}`;
            window.DEBUG_LOGS.push(fullMsg);
            
            const debug = document.getElementById('debug');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = fullMsg;
            debug.appendChild(entry);
            debug.scrollTop = debug.scrollHeight;
            console.log(fullMsg);
        }
        
        // Hook all console methods
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        console.log = function(...args) {
            addLog(args.join(' '), 'info');
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            addLog(args.join(' '), 'error');
            originalError.apply(console, args);
        };
        
        console.warn = function(...args) {
            addLog(args.join(' '), 'warn');
            originalWarn.apply(console, args);
        };
        
        // Hook fetch
        window.originalFetch = window.fetch;
        window.fetch = function(...args) {
            addLog(`FETCH: ${args[0]} ${args[1]?.method || 'GET'}`, 'info');
            return window.originalFetch.apply(window, args)
                .then(r => {
                    addLog(`FETCH RESPONSE: ${args[0]} → ${r.status}`, 'info');
                    return r;
                })
                .catch(e => {
                    addLog(`FETCH ERROR: ${args[0]} → ${e.message}`, 'error');
                    throw e;
                });
        };
        
        // Start
        addLog('=== DEBUG PAGE LOADED ===', 'success');
        addLog(`URL: ${window.location.href}`, 'info');
        addLog(`LocalStorage token: ${localStorage.getItem('token') ? 'EXISTS' : 'NOT FOUND'}`, 'info');
        
        async function testLoadProfile() {
            addLog('Starting simulated profile load...', 'info');
            
            try {
                addLog('Step 1: Checking token...', 'info');
                const token = localStorage.getItem('token');
                
                if (!token) {
                    addLog('Step 2a: No token found. Login manually first (login.html).', 'error');
                    return;
                } else {
                    addLog('Step 2a: Token exists, skipping login', 'info');
                }
                
                addLog('Step 3: Fetching profile with token...', 'info');
                const profileRes = await fetch('http://localhost:5000/api/auth/profile', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                const profileData = await profileRes.json();
                
                if (profileData.success && profileData.user) {
                    addLog(`Step 4: Profile loaded! User: ${profileData.user.firstName} ${profileData.user.lastName}`, 'success');
                    addLog(`Rank: ${profileData.rank.name}`, 'success');
                } else {
                    addLog(`Step 4: FAILED: ${profileData.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addLog(`ERROR: ${error.message}`, 'error');
                addLog(error.stack, 'error');
            }
        }
        
        addLog('All hooks installed, page ready', 'success');
    </script>
</body>
</html>
